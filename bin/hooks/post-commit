#!/usr/bin/env bash


main() {
	local git_root="$(git rev-parse --show-toplevel)"

	# uncomment this line if you want to see the logs
#	exec &> ${git_root}/post-commit.log

	log "get all the files from the last commit."
	local last_commit="$(git log -1 HEAD --pretty=format:%H)"
	local changed_files=$(git diff --cached --name-only --diff-filter=ACDM "$last_commit")
	log "changed files in the last commit:
$changed_files"

	log "set default status as success."
	local status=0

	log "rebuilding worktree of all known auto-generated files that were found in the changed files list."
	echo "$changed_files" | intersection 'usage/.+\.md|gitflux-manifest' | rebuild_worktree
	status=${#PIPESTATUS[@]}

	log "exit with status $status."
	exit $status
}

intersection() {
	local pattern=$1; shift
	local array="$(cat -)"
	if [[ $array =~ $pattern ]]; then
		for item in $array; do
			if [[ $item =~ $pattern ]]; then
				echo "$item"
			fi
		done
	fi
}

rebuild_worktree() {
	local files=$(cat -)
	if [[ $files ]]; then
		log "removing auto-generated files from git, and clearing cache."
		git rm --ignore-unmatch --cached -f -r -- ${files}
		log "checking out the head revision of the cleared files to restore them."
		git checkout HEAD -- ${files}
	fi
}

log() {
	echo " [post-commit] $1"
}


main
