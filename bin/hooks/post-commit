#!/usr/bin/env bash


main() {
	local git_root="$(git rev-parse --show-toplevel)"

	# uncomment this line if you want to see the logs
#	exec &> ${git_root}/post-commit.log

	log "get all the files from the last commit."
	local last_commit="$(git log -1 HEAD --pretty=format:%H)"
	local changed_files=$(git diff --cached --name-only --diff-filter=ACDM "$last_commit")
	log "changed files in the last commit:
$changed_files"

	log "set default status as success."
	local status=0

	# if auto-generated files were found,
	# align worktree changes with index
	if [[ $changed_files =~ usage/.+\.md || $changed_files =~ gitflux-manifest ]]; then
		log "there are changes in auto-generated files, reverting to the index revision. this avoids out-of-sync issues after using '--only'."
		rebuild_worktree "$git_root"
		status=$?
	fi

	log "exit with status $status."
	exit $status
}

rebuild_worktree() {
	local git_root="$1"
	log "removing the usage dir auto-generated files from git, and clearing cache."
	git rm --cached -f -r -- ${git_root}/usage
	log "checking out the head revision of the usage dir."
	git checkout HEAD -- ${git_root}/usage
}

log() {
	echo " [post-commit] $1"
}


main
