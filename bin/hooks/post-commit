#!/usr/bin/env bash


main() {
	local git_root="$(git rev-parse --show-toplevel)"

	# uncomment this line if you want to see the logs
#	exec &> ${git_root}/post-commit.log

	log "get all the files from the last commit."
	local last_commit="$(git log -1 HEAD --pretty=format:%H)"
	local changed_files=$(git diff --cached --name-only --diff-filter=ACDM "$last_commit")
	log "changed files in the last commit:
$changed_files"
	log "--------------------------------------------------"
	log "changed files after intersection:"
	local files_array="$(echo "$changed_files" | intersection 'usage/.+\.md|gitflux-manifest')"
	log "$files_array"
	log "--------------------------------------------------"

	log "set default status as success."
	local status=0

	log "rebuilding worktree of all known auto-generated files that were found in the changed files list."
	echo "$changed_files" | intersection 'usage/.+\.md|gitflux-manifest' | rebuild_worktree


#	# if auto-generated files were found, align worktree changes with index
#	if [[ $changed_files =~ usage/.+\.md || $changed_files =~ gitflux-manifest ]]; then
##	if [[ $changed_files =~ usage/.+\.md|gitflux-manifest ]]; then
#		log "there are changes in auto-generated files, reverting to the index revision."
#		log "this avoids out-of-sync issues after using '--only'."
#		for file in $changed_files; do
#			if [[ $file =~ usage/.+\.md || $changed_files =~ gitflux-manifest ]]; then
#				rebuild_worktree "$file"
#				status=$(( $? + $status ))
#			fi
#		done
#	fi

	log "exit with status $status."
	exit $status
}

intersection() {
	local pattern=$1; shift
	local array="$(cat -)"
	if [[ $array =~ $pattern ]]; then
		for item in $array; do
			if [[ $item =~ $pattern ]]; then
				echo "$item"
			fi
		done
	fi
}

rebuild_worktree() {
	local files=$(cat -)
	log "removing auto-generated files from git, and clearing cache."
	git rm --ignore-unmatch --cached -f -r -- ${files}
	log "checking out the head revision of the cleared files to restore them."
	git checkout HEAD -- ${files}
}

log() {
	echo " [post-commit] $1"
}


main
