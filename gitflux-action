#!/usr/bin/env sh

action_start() {

	local prefix="$1"
	local base_branch="$2"
	local name="$3"
	local base_branch_override="$4"
	
	validate_mandatory_arg "$name"

	local branch="$prefix$name"

	if [[ -n $base_branch_override ]]; then
		base_branch=$base_branch_override
	fi

	validate_git_clean_working_tree
	
	validate_git_local_branch_not_exists "$branch"
	validate_git_remote_branch_not_exists "$branch"
	
	validate_git_local_branch_exists "$base_branch"
	validate_git_remote_branch_exists "$base_branch"

	# save the base to config for the 'finish' command
	git config --global gitflux-branch-base."$(git_config_escape_subsection "$branch")".ref "$base_branch"

	io_log_info "starting '$name'..."

	io_log "switching to base branch '$base_branch'..."
	git_checkout "$base_branch"

	io_log "updating '$base_branch' from the remote..."
	git_pull
	
	io_log "creating the '$branch' local branch and switching to it..."
	git_create_branch "$branch"

	io_log "pushing '$branch' to the remote..."
	git_push_new_branch "$branch"

	io_log_ok "'$name' is started. happy coding!"
}

action_finish() {

	local prefix="$1"
	local name="$2"

	validate_mandatory_arg "$name"
	
	local branch="$prefix$name"
	local base_branch="$(git config --global gitflux-branch-base."$(git_config_escape_subsection "$branch")".ref)"

	validate_git_clean_working_tree

	validate_git_local_branch_exists "$branch"
	validate_git_remote_branch_exists "$branch"
	
	validate_git_local_branch_exists "$base_branch"

	local answer=$(io_prompt "$name's local and remote branches will be deleted, forever. continue? (y/n)")
	if [[ $answer != "y" ]]; then
		io_status_fatal "i knew you'd chicken out."
	fi

	io_log_info "finishing '$name'..."

	io_log "switching to base branch '$base_branch'..."
	git_checkout "$base_branch"

	io_log "deleting the '$branch' local branch..."
	git_delete_local_branch "$branch"

	io_log "deleting the '$branch' remote branch..."
	git_delete_remote_branch "$branch"

	# delete the base from config, we're not gonna need it anymore
	git config --global --remove-section gitflux-branch-base."$(git_config_escape_subsection "$branch")"
	
	io_log_ok "'$name' is finished. RIP."
}

action_sync() {

	local prefix="$1"
	local name="$2"

	validate_mandatory_arg "$name"
	
	local branch="$prefix$name"
	local base_branch="$(git config --global gitflux-branch-base."$(git_config_escape_subsection "$branch")".ref)"

	validate_git_clean_working_tree
	
	validate_git_local_branch_exists "$branch"
	validate_git_remote_branch_exists "$branch"
	
	validate_git_local_branch_exists "$base_branch"
	validate_git_remote_branch_exists "$base_branch"

	io_log_info "syncing '$name' with the base..."

	io_log "switching to base branch '$base_branch'..."
	git_checkout "$base_branch"

	io_log "updating '$base_branch' from the remote..."
	git_pull

	io_log "switching to branch '$branch'..."
	git_checkout "$branch"

	io_log "updating '$branch' from the remote..."
	git_pull

	io_log "merging changes from the '$base_branch' base branch..."
	git_merge "$base_branch"

	io_log_ok "'$name' is synced with the base."
}

action_switch() {

	# todo - check for existing feature branches that belong to the old base, and prompt user (maybe also ask if they want to rebase them?)

	local prefix="$1"
	local key="$2"
	local name="$3"

	validate_mandatory_arg "$name"
	
	local base="$prefix$name"
	
	validate_git_local_branch_exists "$base"
	validate_git_remote_branch_exists "$base"

	io_log_info "switching $key..."

	local old_base="$(git config --global gitflux.branch."$key")"
	if [[ $base = $old_base ]]; then
		io_status_fatal "already in '$base', nothing to do"
	fi
	
	io_log "old base is '$old_base', new is '$base'"

	git config --global gitflux.branch."$key" "$base"

	io_log_ok "$key is switched."
}
