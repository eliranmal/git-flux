#!/usr/bin/env sh


create_branch_from_base() {
	local branch="$1"; local base_default="$2"; local base_override="$3"
	local base_branch=${base_override:-$base_default}

	validate_git_clean_working_tree
	validate_git_local_and_remote_branches_dont_exist "$branch"
	validate_git_local_and_remote_branches_exist "$base_branch"

	git_checkout "$base_branch"
	git_pull
	git_create_and_push_branch "$branch"

	# save the base to config for the 'finish' command
	git_config_set "$(git_config_escape_subsection "branch:$branch").base" "$base_branch"
}

create_branch_from_tag() {
	local branch="$1"; local tag="$2"

	validate_git_clean_working_tree
	validate_git_local_and_remote_branches_dont_exist "$branch"
	validate_git_tag_exists "$tag"

	git_checkout "$tag"
	git_create_and_push_branch "$branch"

	# save the base to config for the 'finish' command
	git_config_set "$(git_config_escape_subsection "branch:$branch").base" "$tag"
}

destroy_branch_from_base() {
	io_log; io_confirm "local and remote branches will be deleted, forever! continue?" "i knew you'd chicken out."

	local branch="$1"
	local base_branch="$(git_config_get "$(git_config_escape_subsection "branch:$branch").base")"

	validate_git_clean_working_tree
	# todo - don't validate that - ensure we delete these branches instead (quite-fail wherever possible)
	validate_git_local_and_remote_branches_exist "$branch"
	validate_git_local_branch_exists "$base_branch"

	git_checkout "$base_branch"
	git_delete_local_and_remote_branches "$branch"

	# delete the base from config, we're not gonna need it anymore
	git_config_remove_section "$(git_config_escape_subsection "branch:$branch")"
}

destroy_branch_from_tag() {
	io_log; io_confirm "local and remote branches will be deleted, forever! continue?" "i knew you'd chicken out."

	local branch="$1"
	local tag="$(git_config_get "$(git_config_escape_subsection "branch:$branch").base")"

	validate_git_clean_working_tree
	validate_git_local_and_remote_branches_exist "$branch"
	validate_git_tag_exists "$tag"

	git_checkout "$tag"
	git_delete_local_and_remote_branches "$branch"

	# delete the base from config, we're not gonna need it anymore
	git_config_remove_section "$(git_config_escape_subsection "branch:$branch")"
}

sync_branch_with_base() {
	local branch="$1"; local base_override="$2"
	local base_default="$(git_config_get "$(git_config_escape_subsection "branch:$branch").base")"
	local base_branch=${base_override:-$base_default}

	validate_git_clean_working_tree
	validate_git_local_and_remote_branches_exist "$branch"	
	validate_git_local_and_remote_branches_exist "$base_branch"

	git_checkout "$base_branch"
	git_pull
	git_checkout "$branch"
	git_pull
	git_merge "$base_branch"
}
